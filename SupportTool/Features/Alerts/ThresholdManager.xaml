<?xml version="1.0" encoding="utf-8" ?>
<Page
    x:Class="SupportTool.ThresholdManager"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="using:SupportTool.Features.Alerts.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="using:SupportTool"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:SupportTool.Features.Alerts.Models"
    mc:Ignorable="d">

    <Page.Resources>
        <converters:NullableDoubleToDashConverter x:Key="NullableDoubleToDashConverter" />
        <converters:ThresholdDifferenceToBrushConverter x:Key="ThresholdDifferenceToBrushConverter" />
    </Page.Resources>

    <Grid x:Name="RootGrid" Padding="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="auto" />
            <RowDefinition Height="auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <Grid Grid.Row="1" Grid.ColumnSpan="3">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <TextBlock
                Grid.Column="0"
                Margin="0,0,0,20"
                Style="{StaticResource TitleTextBlockStyle}"
                Text="Threshold Management" />

            <StackPanel
                Grid.Column="2"
                VerticalAlignment="Center"
                Orientation="Horizontal"
                Spacing="10">
                <ComboBox
                    x:Name="stacksComboBox"
                    Width="200"
                    PlaceholderText="Select a stack..."
                    SelectionChanged="StacksComboBox_SelectionChanged" />
                <Button
                    x:Name="CalculateTimesButton"
                    Click="CalculateTimesButton_Click"
                    Content="Calculate times"
                    ToolTipService.ToolTip="Fetch proposed times from New Relic for all listed carriers" />
                <Button
                    x:Name="ApplySelectedThresholdsButton"
                    Click="ApplySelectedThresholdsButton_Click"
                    Content="Apply Selected Thresholds"
                    Style="{StaticResource AccentButtonStyle}"
                    ToolTipService.ToolTip="Apply the proposed threshold to all selected alerts and save" />
            </StackPanel>
        </Grid>

        <Grid
            Grid.Row="2"
            Grid.Column="0"
            Padding="5"
            VerticalAlignment="Stretch"
            Background="{ThemeResource LayerFillColorDefaultBrush}"
            CornerRadius="6"
            RowSpacing="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <Grid Grid.Row="0" Margin="10,0,10,10">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="3*" />
                    <ColumnDefinition Width="Auto" MinWidth="200" />
                    <ColumnDefinition Width="Auto" MinWidth="200" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <StackPanel
                    Grid.ColumnSpan="4"
                    Margin="0,0,0,8"
                    Orientation="Horizontal"
                    Spacing="8" />
                <Button
                    Grid.Column="0"
                    HorizontalAlignment="Stretch"
                    Content="Alert Name"
                    CornerRadius="5,0,0,5" />
                <Button
                    Grid.Column="1"
                    HorizontalAlignment="Stretch"
                    Content="Critical Duration"
                    CornerRadius="0,0,0,0" />
                <Button
                    Grid.Column="2"
                    HorizontalAlignment="Stretch"
                    Content="Proposed Value"
                    CornerRadius="0,0,0,0" />
                <Button
                    Grid.Column="3"
                    Click="CopyNrqlButton_Click"
                    Content="Copy NRQL"
                    CornerRadius="0,5,5,0"
                    Tag="{x:Bind}" />
            </Grid>

            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                <ListView
                    x:Name="AlertsListView"
                    ItemsSource="{x:Bind AlertItems, Mode=OneWay}"
                    SelectionMode="Multiple">
                    <ListView.ItemTemplate>
                        <DataTemplate x:DataType="models:NrqlAlert">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="3*" />
                                    <ColumnDefinition Width="Auto" MinWidth="200" />
                                    <ColumnDefinition Width="Auto" MinWidth="200" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBlock
                                    Grid.Column="0"
                                    VerticalAlignment="Center"
                                    Text="{x:Bind Name}" />
                                <TextBlock
                                    Grid.Column="1"
                                    VerticalAlignment="Center"
                                    Text="{x:Bind CriticalThreshold}" />
                                <TextBox
                                    Grid.Column="2"
                                    MinWidth="80"
                                    HorizontalAlignment="Stretch"
                                    VerticalAlignment="Center"
                                    PlaceholderText="No data"
                                    Text="{x:Bind ProposedThreshold, Mode=TwoWay, Converter={StaticResource NullableDoubleToDashConverter}, UpdateSourceTrigger=PropertyChanged}" />
                                <Button
                                    Grid.Column="3"
                                    Margin="40,0,20,0"
                                    Click="CopyNrqlButton_Click"
                                    Tag="{x:Bind}">
                                    <FontIcon FontSize="12" Glyph="&#xE8C8;" />
                                </Button>
                            </Grid>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            </ScrollViewer>

            <!-- Overlay to block interactions when progress is shown -->
            <Rectangle
                x:Name="AlertFetchingOverlay"
                Grid.Row="1"
                Canvas.ZIndex="100"
                Fill="{ThemeResource SystemControlBackgroundAltHighBrush}"
                Opacity="0.2"
                Visibility="Collapsed"
                IsHitTestVisible="True" />

            <Border
                x:Name="AlertFetchingProgress"
                Grid.Row="1"
                Canvas.ZIndex="200"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Background="{ThemeResource SystemControlBackgroundAltHighBrush}"
                Opacity="0.95"
                CornerRadius="8"
                Padding="24"
                Visibility="Collapsed">
                <StackPanel Orientation="Vertical" Spacing="16">
                    <TextBlock
                        HorizontalAlignment="Center"
                        Text="Calculating carrier performance..."
                        Style="{StaticResource BodyTextBlockStyle}" />
                    <ProgressRing
                        x:Name="AlertFetchingProgressRing"
                        IsActive="False"
                        HorizontalAlignment="Center" />
                </StackPanel>
            </Border>
        </Grid>

        <Canvas
            x:Name="ToastContainer"
            HorizontalAlignment="Stretch"
            VerticalAlignment="Stretch"
            IsHitTestVisible="True" />
    </Grid>
</Page>
